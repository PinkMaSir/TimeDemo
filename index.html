
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>假时间计算器</title>
    <style>
        /* 基础样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: #f9fafb;
            color: #1e293b;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            background-color: #111827;
            color: #f3f4f6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* 头部样式 */
        header {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 50;
            transition: padding 0.3s;
            padding: 1rem 0;
        }
        
        header.dark-mode {
            background-color: #1f2937;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .nav-links {
            display: flex;
            gap: 1.5rem;
        }
        
        .nav-link {
            color: #4b5563;
            text-decoration: none;
            transition: color 0.2s;
        }
        
        .dark-mode .nav-link {
            color: #d1d5db;
        }
        
        .nav-link:hover {
            color: #3b82f6;
        }
        
        .btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-secondary {
            background-color: #10b981;
        }
        
        .btn-secondary:hover {
            background-color: #059669;
        }
        
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4b5563;
        }
        
        .dark-mode .mobile-menu-btn {
            color: #d1d5db;
        }
        
        /* 主内容区样式 */
        main {
            padding: 2rem 0;
        }
        
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .dark-mode .card {
            background-color: #1f2937;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
        }
        
        .dark-mode .card-title {
            color: #f3f4f6;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: white;
            color: #1e293b;
        }
        
        .dark-mode input, 
        .dark-mode textarea, 
        .dark-mode select {
            background-color: #374151;
            border-color: #4b5563;
            color: #f3f4f6;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
        }
        
        .form-actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }
        
        /* 结果区域样式 */
        .results-container {
            display: none;
        }
        
        .no-results, .error-message {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        
        .no-results {
            background-color: #f3f4f6;
            color: #4b5563;
        }
        
        .dark-mode .no-results {
            background-color: #374151;
            color: #d1d5db;
        }
        
        .error-message {
            background-color: #fee2e2;
            color: #dc2626;
            display: none;
        }
        
        .dark-mode .error-message {
            background-color: #450a0a;
        }
        
        .query-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .dark-mode .query-section {
            border-top-color: #374151;
        }
        
        .query-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .query-result {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #eff6ff;
            border-radius: 0.375rem;
            display: none;
        }
        
        .dark-mode .query-result {
            background-color: #1e3a8a;
        }
        
        .query-error {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #fee2e2;
            color: #dc2626;
            border-radius: 0.375rem;
            display: none;
        }
        
        .dark-mode .query-error {
            background-color: #450a0a;
        }
        
        /* 表格样式 */
        .table-container {
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .dark-mode th, 
        .dark-mode td {
            border-bottom-color: #374151;
        }
        
        th {
            font-weight: 600;
            background-color: #f8fafc;
        }
        
        .dark-mode th {
            background-color: #1f2937;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        .dark-mode tr:nth-child(even) {
            background-color: #374151;
        }
        
        .text-primary {
            color: #3b82f6;
        }
        
        /* 图表样式 */
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 1.5rem;
        }
        
        svg {
            width: 100%;
            height: 100%;
        }
        
        .chart-grid {
            stroke: #e5e7eb;
            stroke-width: 1;
        }
        
        .dark-mode .chart-grid {
            stroke: #374151;
        }
        
        .chart-line {
            stroke: #3b82f6;
            stroke-width: 2;
            fill: none;
        }
        
        .chart-area {
            fill: rgba(59, 130, 246, 0.1);
        }
        
        .chart-point {
            fill: #3b82f6;
        }
        
        .chart-axis {
            stroke: #9ca3af;
            stroke-width: 1;
        }
        
        .dark-mode .chart-axis {
            stroke: #6b7280;
        }
        
        .chart-label {
            font-size: 12px;
            fill: #6b7280;
            text-anchor: middle;
        }
        
        .dark-mode .chart-label {
            fill: #d1d5db;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            fill: #1f2937;
        }
        
        .dark-mode .chart-title {
            fill: #f3f4f6;
        }
        
        /* 帮助模态框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal {
            background-color: white;
            border-radius: 0.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }
        
        .dark-mode .modal {
            background-color: #1f2937;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .modal-content p {
            margin-bottom: 1rem;
        }
        
        .modal-close {
            margin-top: 1rem;
            text-align: right;
        }
        
        /* 页脚样式 */
        footer {
            background-color: white;
            border-top: 1px solid #e5e7eb;
            padding: 2rem 0;
            margin-top: 2rem;
        }
        
        .dark-mode footer {
            background-color: #1f2937;
            border-top-color: #374151;
        }
        
        .footer-content {
            text-align: center;
            color: #6b7280;
        }
        
        .dark-mode .footer-content {
            color: #9ca3af;
        }
        
        /* 移动端样式 */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background-color: white;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 1rem;
                gap: 0.5rem;
            }
            
            .dark-mode .nav-links {
                background-color: #1f2937;
            }
            
            .nav-links.show {
                display: flex;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .query-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* 动画效果 */
        .animate-pulse {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <header id="header">
        <div class="container header-content">
            <div class="logo">假时间计算器</div>
            <button id="mobileMenuBtn" class="mobile-menu-btn">
                ☰
            </button>
            <nav class="nav-links" id="mobileMenu">
                <a href="#" class="nav-link" id="helpBtn">帮助</a>
                <button class="nav-link" id="themeToggle">
                    <span id="themeIcon">🌙</span>
                </button>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <h2 class="card-title">输入参数</h2>
            <form id="calculatorForm">
                <div class="form-group">
                    <label for="timePoints">时间点 (小时)，用空格分隔</label>
                    <textarea id="timePoints" rows="3" placeholder="例如: 0 0.25 0.5 ..."></textarea>
                </div>
                <div class="form-group">
                    <label for="gasViscosity">气体粘度 (mPa·s)，用空格分隔，与时间点一一对应</label>
                    <textarea id="gasViscosity" rows="3" placeholder="例如: 0.0144 0.01536 0.01596 ..."></textarea>
                </div>
                <div class="form-group">
                    <label for="compressibility">压缩系数 (MPa⁻¹)，用空格分隔，与时间点一一对应</label>
                    <textarea id="compressibility" rows="3" placeholder="例如: 0.1244 0.0991 0.08657 ..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn">计算假时间</button>
                    <button type="button" class="btn btn-secondary" id="loadExampleBtn">加载示例数据</button>
                </div>
            </form>
        </div>

        <div id="noResultsMessage" class="no-results">
            请输入数据并点击"计算假时间"按钮
        </div>

        <div id="errorMessage" class="error-message">
            <span id="errorText"></span>
        </div>

        <div id="resultsContainer" class="results-container">
            <div class="card">
                <h2 class="card-title">计算结果</h2>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>时间 t (h)</th>
                                <th>时间间隔 dt (h)</th>
                                <th>时间间隔 dt (s)</th>
                                <th>A = 1/(μ·C)</th>
                                <th>B值</th>
                                <th>C'值</th>
                                <th>假时间 tₐ</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- 结果将在这里动态填充 -->
                        </tbody>
                    </table>
                </div>

                <div class="chart-container">
                    <svg id="timeChart"></svg>
                </div>

                <div class="query-section">
                    <h3 class="card-title">查询特定时间的假时间</h3>
                    <div class="query-group">
                        <div class="form-group" style="flex: 1;">
                            <label for="queryTime">输入时间 (小时)</label>
                            <input type="number" id="queryTime" step="0.01" disabled>
                        </div>
                        <button id="queryButton" class="btn" style="flex-shrink: 0;" disabled>查询</button>
                    </div>
                    <div id="queryResult" class="query-result">
                        <span id="queryResultText"></span>
                    </div>
                    <div id="queryError" class="query-error">
                        <span id="queryErrorText"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container footer-content">
            <p>假时间计算器 &copy; 2023 - 离线版</p>
        </div>
    </footer>

    <!-- 帮助模态框 -->
    <div id="helpModal" class="modal-overlay">
        <div class="modal">
            <h3 class="modal-title">使用帮助</h3>
            <div class="modal-content">
                <p>假时间计算器用于计算油气藏工程中的假时间参数，基于以下公式：</p>
                <p>1. 计算 A = 1/(μ₉·Cₜ)</p>
                <p>2. 计算时间间隔并转换为秒</p>
                <p>3. 计算 B 值（A 值的平均值）</p>
                <p>4. 计算 C' 值 = B·Δt(秒)</p>
                <p>5. 假时间 tₐ 为 C' 值的累积和</p>
                <p>使用方法：</p>
                <p>1. 输入时间点、气体粘度和压缩系数，用空格分隔</p>
                <p>2. 点击"计算假时间"按钮</p>
                <p>3. 查看计算结果表格和图表</p>
                <p>4. 可在结果区域查询特定时间点的假时间</p>
            </div>
            <div class="modal-close">
                <button id="closeHelpBtn" class="btn">关闭</button>
            </div>
        </div>
    </div>

    <script>
        // 示例数据
        const exampleData = {
            timePoints: [0, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2, 2.25, 2.5, 2.75, 3],
            gasViscosity: [0.0144, 0.01536, 0.01596, 0.01647, 0.01689, 0.01726, 0.01755, 0.01778, 0.01802, 0.01825, 0.01843, 0.01859, 0.01872],
            compressibility: [0.1244, 0.0991, 0.08657, 0.07756, 0.072, 0.0675, 0.06431, 0.06189, 0.05943, 0.05724, 0.05557, 0.05412, 0.05302]
        };

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 加载示例数据按钮事件
            document.getElementById('loadExampleBtn').addEventListener('click', () => {
                document.getElementById('timePoints').value = exampleData.timePoints.join(' ');
                document.getElementById('gasViscosity').value = exampleData.gasViscosity.join(' ');
                document.getElementById('compressibility').value = exampleData.compressibility.join(' ');
            });
        });

        // 全局变量
        let calculationResults = null;
        
        // DOM元素
        const form = document.getElementById('calculatorForm');
        const resultsContainer = document.getElementById('resultsContainer');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const resultsTableBody = document.getElementById('resultsTableBody');
        const queryTimeInput = document.getElementById('queryTime');
        const queryButton = document.getElementById('queryButton');
        const queryResult = document.getElementById('queryResult');
        const queryResultText = document.getElementById('queryResultText');
        const queryError = document.getElementById('queryError');
        const queryErrorText = document.getElementById('queryErrorText');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpBtn = document.getElementById('closeHelpBtn');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const header = document.getElementById('header');
        const loadExampleBtn = document.getElementById('loadExampleBtn');
        
        // 移动端菜单切换
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('show');
        });
        
        // 帮助模态框控制
        function openHelpModal() {
            helpModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeHelpModal() {
            helpModal.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        helpBtn.addEventListener('click', openHelpModal);
        closeHelpBtn.addEventListener('click', closeHelpModal);
        
        // 点击模态框外部关闭
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                closeHelpModal();
            }
        });
        
        // 主题切换
        themeToggle.addEventListener('click', toggleTheme);
        
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            header.classList.toggle('dark-mode');
            
            const isDark = document.body.classList.contains('dark-mode');
            
            if (isDark) {
                themeIcon.textContent = '☀️';
            } else {
                themeIcon.textContent = '🌙';
            }
            
            // 如果图表已存在，更新主题
            if (calculationResults) {
                createChart(calculationResults.t, calculationResults.t_a);
            }
        }
        
        // 表单提交处理
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            calculatePseudoTime();
        });
        
        // 查询按钮点击处理
        queryButton.addEventListener('click', () => {
            queryPseudoTime();
        });
        
        // 按Enter键查询
        queryTimeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                queryPseudoTime();
            }
        });
        
        // 假时间计算函数
        function calculatePseudoTime() {
            // 获取输入值
            const timePointsStr = document.getElementById('timePoints').value.trim();
            const gasViscosityStr = document.getElementById('gasViscosity').value.trim();
            const compressibilityStr = document.getElementById('compressibility').value.trim();
            
            // 解析输入为数组
            try {
                const t = timePointsStr.split(/\s+/).map(Number);
                const mu_g = gasViscosityStr.split(/\s+/).map(Number);
                const C_t = compressibilityStr.split(/\s+/).map(Number);
                
                // 验证输入
                if (t.length === 0 || mu_g.length === 0 || C_t.length === 0) {
                    showError('请输入有效的数值');
                    return;
                }
                
                if (!(t.length === mu_g.length && mu_g.length === C_t.length)) {
                    showError('时间点、粘度和压缩系数的数值数量必须相同');
                    return;
                }
                
                // 检查是否有非数值
                if (t.some(isNaN) || mu_g.some(isNaN) || C_t.some(isNaN)) {
                    showError('输入包含非数值，请检查');
                    return;
                }
                
                // 检查是否有负值
                if (t.some(v => v < 0) || mu_g.some(v => v <= 0) || C_t.some(v => v <= 0)) {
                    showError('时间点不能为负，粘度和压缩系数必须为正数');
                    return;
                }
                
                // 检查时间点是否递增
                for (let i = 1; i < t.length; i++) {
                    if (t[i] <= t[i-1]) {
                        showError('时间点必须按递增顺序输入');
                        return;
                    }
                }
                
                // 执行计算
                const results = performCalculation(t, mu_g, C_t);
                
                // 存储计算结果
                calculationResults = results;
                
                // 显示结果
                displayResults(results);
                
                // 启用查询功能
                queryTimeInput.disabled = false;
                queryButton.disabled = false;
                queryTimeInput.focus();
                
            } catch (error) {
                showError('计算过程中发生错误: ' + error.message);
            }
        }
        
        // 执行具体计算
        function performCalculation(t, mu_g, C_t) {
            const n = t.length;
            
            // 步骤1：计算A = 1/(μ_g * C_t)
            const A = mu_g.map((mu, i) => 1 / (mu * C_t[i]));
            
            // 步骤2：计算时间间隔（小时）并转换为秒
            const dt_h = [];
            for (let i = 0; i < n - 1; i++) {
                dt_h.push(t[i + 1] - t[i]);
            }
            // 最后一个间隔使用前一个间隔的值
            dt_h.push(dt_h.length > 0 ? dt_h[dt_h.length - 1] : 0);
            
            const dt_sec = dt_h.map(dt => dt * 3600);
            
            // 步骤3：计算B值
            const B = new Array(n).fill(0);
            B[0] = A[0] / 2;  // 第一个B值：A(1)/2
            
            for (let i = 1; i < n - 1; i++) {
                B[i] = (A[i - 1] + A[i]) / 2;  // 中间B值：相邻A的平均值
            }
            
            if (n > 1) {
                B[n - 1] = (A[n - 2] + A[n - 1]) / 2;  // 最后一个B值
            }
            
            // 步骤4：计算C'值
            const C_prime = B.map((b, i) => b * dt_sec[i]);
            
            // 步骤5：计算假时间t_a
            const t_a = new Array(n).fill(0);
            t_a[0] = C_prime[0];  // 第一个假时间
            
            for (let i = 1; i < n; i++) {
                t_a[i] = t_a[i - 1] + C_prime[i];  // 累加计算
            }
            
            // 整理结果
            const results = [];
            for (let i = 0; i < n; i++) {
                results.push({
                    t: t[i],
                    dt_h: dt_h[i],
                    dt_sec: dt_sec[i],
                    A: A[i],
                    B: B[i],
                    C_prime: C_prime[i],
                    t_a: t_a[i]
                });
            }
            
            return {
                results,
                t,
                t_a
            };
        }
        
        // 显示计算结果
        function displayResults(results) {
            // 隐藏错误信息和无结果信息
            errorMessage.style.display = 'none';
            noResultsMessage.style.display = 'none';
            // 显示结果容器
            resultsContainer.style.display = 'block';
            
            // 清空表格
            resultsTableBody.innerHTML = '';
            
            // 填充表格
            results.results.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">${item.t.toFixed(4)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${item.dt_h.toFixed(4)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${Math.round(item.dt_sec)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${item.A.toFixed(6)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${item.B.toFixed(6)}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${item.C_prime.toFixed(4)}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-medium text-primary">${item.t_a.toFixed(4)}</td>
                `;
                resultsTableBody.appendChild(row);
            });
            
            // 创建图表（使用原生SVG）
            createChart(results.t, results.t_a);
            
            // 平滑滚动到结果区域
            resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // 使用原生SVG创建假时间与实际时间关系图 - 横纵坐标都从0开始
        function createChart(t, t_a) {
            // 获取SVG元素并清空
            const svg = document.getElementById('timeChart');
            svg.innerHTML = '';
            
            // 获取SVG尺寸
            const svgWidth = svg.clientWidth;
            const svgHeight = svg.clientHeight;
            
            // 边距
            const margin = { top: 30, right: 30, bottom: 40, left: 60 };
            const chartWidth = svgWidth - margin.left - margin.right;
            const chartHeight = svgHeight - margin.top - margin.bottom;
            
            // 计算数据范围 - 确保从0开始
            const tMin = 0; // X轴从0开始
            const tMax = Math.max(...t);
            const tRange = tMax - tMin;
            
            const t_aMin = 0; // Y轴从0开始
            const t_aMax = Math.max(...t_a);
            const t_aRange = t_aMax - t_aMin;
            
            // 添加10%的额外空间，使数据不紧贴坐标轴
            const tPadding = tRange > 0 ? tRange * 0.1 : 1;
            const t_aPadding = t_aRange > 0 ? t_aRange * 0.1 : 1;
            
            // 比例尺函数 - 将数据值映射到图表坐标
            const xScale = (value) => {
                return margin.left + (value - tMin) / 
                    ((tMax + tPadding) - tMin) * chartWidth;
            };
            
            const yScale = (value) => {
                return margin.top + chartHeight - (value - t_aMin) / 
                    ((t_aMax + t_aPadding) - t_aMin) * chartHeight;
            };
            
            // 创建坐标轴
            // X轴
            const xAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
            xAxis.setAttribute('x1', margin.left);
            xAxis.setAttribute('y1', margin.top + chartHeight);
            xAxis.setAttribute('x2', margin.left + chartWidth);
            xAxis.setAttribute('y2', margin.top + chartHeight);
            xAxis.setAttribute('class', 'chart-axis');
            svg.appendChild(xAxis);
            
            // Y轴
            const yAxis = document.createElementNS("http://www.w3.org/2000/svg", "line");
            yAxis.setAttribute('x1', margin.left);
            yAxis.setAttribute('y1', margin.top);
            yAxis.setAttribute('x2', margin.left);
            yAxis.setAttribute('y2', margin.top + chartHeight);
            yAxis.setAttribute('class', 'chart-axis');
            svg.appendChild(yAxis);
            
            // X轴标签
            const xLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            xLabel.setAttribute('x', margin.left + chartWidth / 2);
            xLabel.setAttribute('y', svgHeight - 10);
            xLabel.textContent = '实际时间 (小时)';
            xLabel.setAttribute('class', 'chart-label');
            svg.appendChild(xLabel);
            
            // Y轴标签
            const yLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
            yLabel.setAttribute('x', -svgHeight / 2);
            yLabel.setAttribute('y', 20);
            yLabel.setAttribute('transform', 'rotate(-90)');
            yLabel.textContent = '假时间';
            yLabel.setAttribute('class', 'chart-label');
            svg.appendChild(yLabel);
            
            // 绘制网格线 - X方向
            const xGridCount = 5;
            for (let i = 0; i <= xGridCount; i++) {
                const x = margin.left + (i / xGridCount) * chartWidth;
                const gridLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                gridLine.setAttribute('x1', x);
                gridLine.setAttribute('y1', margin.top);
                gridLine.setAttribute('x2', x);
                gridLine.setAttribute('y2', margin.top + chartHeight);
                gridLine.setAttribute('class', 'chart-grid');
                svg.appendChild(gridLine);
                
                // 网格标签
                const gridValue = tMin + (i / xGridCount) * (tMax + tPadding);
                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                label.setAttribute('x', x);
                label.setAttribute('y', margin.top + chartHeight + 20);
                label.textContent = gridValue.toFixed(2);
                label.setAttribute('class', 'chart-label');
                svg.appendChild(label);
            }
            
            // 绘制网格线 - Y方向
            const yGridCount = 5;
            for (let i = 0; i <= yGridCount; i++) {
                const y = margin.top + (i / yGridCount) * chartHeight;
                const gridLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                gridLine.setAttribute('x1', margin.left);
                gridLine.setAttribute('y1', y);
                gridLine.setAttribute('x2', margin.left + chartWidth);
                gridLine.setAttribute('y2', y);
                gridLine.setAttribute('class', 'chart-grid');
                svg.appendChild(gridLine);
                
                // 网格标签
                const gridValue = t_aMin + (yGridCount - i) / yGridCount * (t_aMax + t_aPadding);
                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                label.setAttribute('x', margin.left - 10);
                label.setAttribute('y', y + 4);
                label.setAttribute('text-anchor', 'end');
                label.textContent = gridValue.toFixed(2);
                label.setAttribute('class', 'chart-label');
                svg.appendChild(label);
            }
            
            // 准备路径数据
            let pathData = `M ${xScale(t[0])} ${yScale(t_a[0])}`;
            let areaData = `M ${xScale(t[0])} ${yScale(t_a[0])}`;
            
            for (let i = 1; i < t.length; i++) {
                pathData += ` L ${xScale(t[i])} ${yScale(t_a[i])}`;
                areaData += ` L ${xScale(t[i])} ${yScale(t_a[i])}`;
            }
            
            // 闭合面积路径 - 连接到底部X轴
            areaData += ` L ${xScale(t[t.length - 1])} ${yScale(t_aMin)}`;
            areaData += ` L ${xScale(t[0])} ${yScale(t_aMin)} Z`;
            
            // 绘制面积
            const area = document.createElementNS("http://www.w3.org/2000/svg", "path");
            area.setAttribute('d', areaData);
            area.setAttribute('class', 'chart-area');
            svg.appendChild(area);
            
            // 绘制线
            const line = document.createElementNS("http://www.w3.org/2000/svg", "path");
            line.setAttribute('d', pathData);
            line.setAttribute('class', 'chart-line');
            svg.appendChild(line);
            
            // 绘制数据点
            t.forEach((time, i) => {
                const point = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                point.setAttribute('cx', xScale(time));
                point.setAttribute('cy', yScale(t_a[i]));
                point.setAttribute('r', 4);
                point.setAttribute('class', 'chart-point');
                
                // 添加悬停提示
                point.setAttribute('title', `时间: ${time.toFixed(4)}, 假时间: ${t_a[i].toFixed(4)}`);
                svg.appendChild(point);
            });
            
            // 应用深色模式样式
            if (document.body.classList.contains('dark-mode')) {
                document.querySelectorAll('.chart-grid').forEach(el => {
                    el.classList.add('dark-mode');
                });
                document.querySelectorAll('.chart-axis').forEach(el => {
                    el.classList.add('dark-mode');
                });
                document.querySelectorAll('.chart-label, .chart-title').forEach(el => {
                    el.classList.add('dark-mode');
                });
            } else {
                document.querySelectorAll('.chart-grid').forEach(el => {
                    el.classList.remove('dark-mode');
                });
                document.querySelectorAll('.chart-axis').forEach(el => {
                    el.classList.remove('dark-mode');
                });
                document.querySelectorAll('.chart-label, .chart-title').forEach(el => {
                    el.classList.remove('dark-mode');
                });
            }
        }
        
        // 响应窗口大小变化重绘图表
        window.addEventListener('resize', () => {
            if (calculationResults) {
                createChart(calculationResults.t, calculationResults.t_a);
            }
        });
        
        // 查询任意时间点的假时间
        function queryPseudoTime() {
            if (!calculationResults) return;
            
            // 隐藏之前的结果和错误
            queryResult.style.display = 'none';
            queryError.style.display = 'none';
            
            // 获取查询时间
            const t_query = parseFloat(queryTimeInput.value);
            
            // 验证输入
            if (isNaN(t_query)) {
                showQueryError('请输入有效的时间值');
                return;
            }
            
            const t = calculationResults.t;
            const t_a = calculationResults.t_a;
            
            // 检查时间范围
            if (t_query < t[0]) {
                showQueryError(`查询时间必须大于等于 ${t[0].toFixed(4)} 小时`);
                return;
            }
            
            if (t_query > t[t.length - 1]) {
                showQueryError(`查询时间必须小于等于 ${t[t.length - 1].toFixed(4)} 小时`);
                return;
            }
            
            // 找到查询时间所在的区间
            let t_a_query;
            if (t_query === t[0]) {
                t_a_query = t_a[0];
            } else {
                // 查找查询时间所在的区间索引
                let idx = 0;
                for (let i = 0; i < t.length; i++) {
                    if (t[i] < t_query) {
                        idx = i;
                    } else {
                        break;
                    }
                }
                
                // 计算该区间内的时间比例
                const t_start = t[idx];
                const t_end = t[idx + 1];
                const ratio = (t_query - t_start) / (t_end - t_start);
                
                // 计算对应的假时间
                const t_a_start = t_a[idx];
                const t_a_end = t_a[idx + 1];
                t_a_query = t_a_start + ratio * (t_a_end - t_a_start);
            }
            
            // 显示查询结果
            queryResultText.textContent = `时间 ${t_query.toFixed(4)} 小时对应的假时间为: ${t_a_query.toFixed(4)}`;
            queryResult.style.display = 'block';
            
            // 添加结果高亮动画
            queryResult.classList.add('animate-pulse');
            setTimeout(() => {
                queryResult.classList.remove('animate-pulse');
            }, 1000);
        }
        
        // 显示错误信息
        function showError(message) {
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            resultsContainer.style.display = 'none';
            noResultsMessage.style.display = 'none';
            
            // 禁用查询功能
            queryTimeInput.disabled = true;
            queryButton.disabled = true;
        }
        
        // 显示查询错误
        function showQueryError(message) {
            queryErrorText.textContent = message;
            queryError.style.display = 'block';
        }
        
        // 页面滚动效果 - 导航栏样式变化
        window.addEventListener('scroll', () => {
            if (window.scrollY > 10) {
                header.style.padding = '0.5rem 0';
            } else {
                header.style.padding = '1rem 0';
            }
        });
    </script>
</body>
</html>
